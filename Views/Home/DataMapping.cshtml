@{
    ViewData["Title"] = "Сопоставление данных";
}

<style>
    #modalExistingSvsContainer {
        max-height: 280px;
        overflow-y: auto;
    }

    #modalExistingSvsList .list-group-item {
        cursor: pointer;
    }
</style>

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h3 class="card-title mb-0">
                        <i class="fas fa-exchange-alt me-2"></i>Сопоставление данных
                    </h3>
                </div>
                <div class="card-body">
                    <p>На этой странице вы можете просматривать данные расхода и прихода по организациям, редактировать коды СВС и выгружать данные в JSON.</p>

                    <div class="row mb-3">
                        <div class="col-md-3">
                            <label for="mappingEducationDepartmentSelect" class="form-label">УО *</label>
                            <select class="form-select" id="mappingEducationDepartmentSelect" onchange="loadOrganizationsForMapping()" required>
                                <option value="">Выберите УО</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="mappingOrganizationSelect" class="form-label">Организация *</label>
                            <select class="form-select" id="mappingOrganizationSelect" required disabled>
                                <option value="">Сначала выберите УО</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Тип данных</label>
                            <div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" name="dataType" id="dataTypeConsumption" value="consumption" checked>
                                    <label class="form-check-label" for="dataTypeConsumption">Расход</label>
                                </div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" name="dataType" id="dataTypeReceipts" value="receipts">
                                    <label class="form-check-label" for="dataTypeReceipts">Приход</label>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <label for="dataDate" class="form-label">Дата (опционально)</label>
                            <input type="date" class="form-control" id="dataDate">
                            <small class="text-muted">Если не указана, будут загружены все данные</small>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-12">
                            <button class="btn btn-primary" onclick="loadData()"><i class="fas fa-search me-1"></i>Загрузить данные</button>
                            <button class="btn btn-success ms-2" onclick="downloadExport()"><i class="fas fa-download me-1"></i>Выгрузить JSON</button>
                        </div>
                    </div>

                    <div class="mb-3">
                        <input type="text" class="form-control" id="mappingSearchInput" placeholder="Поиск по названию продукта или коду СВС..." onkeyup="filterData()">
                    </div>

                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead class="table-dark">
                                <tr id="tableHeader">
                                    <!-- Заголовки будут заполнены динамически -->
                                </tr>
                            </thead>
                            <tbody id="dataTableBody">
                                <tr><td colspan="10" class="text-center">Выберите организацию и тип данных, затем нажмите "Загрузить данные". Дата опциональна.</td></tr>
                            </tbody>
                        </table>
                    </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal для редактирования кода СВС -->
<div class="modal fade" id="editSvsCodeModal" tabindex="-1" aria-labelledby="editSvsCodeModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editSvsCodeModalLabel">Редактировать код СВС</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="saveSvsCodeForm">
                    <input type="hidden" id="modalRecordId">
                    <input type="hidden" id="modalRecordType">
                    <div class="mb-3">
                        <label for="modalProductName" class="form-label">Продукт</label>
                        <input type="text" class="form-control" id="modalProductName" readonly>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Существующие коды СВС</label>
                        <button class="btn btn-outline-secondary w-100 text-start" type="button" data-bs-toggle="collapse" data-bs-target="#modalExistingSvsCollapse" aria-expanded="false" aria-controls="modalExistingSvsCollapse" id="modalExistingSvsToggle">
                            <i class="fas fa-list me-2"></i><span id="modalExistingSvsSelectedText">Показать список кодов</span>
                        </button>
                        <div class="collapse mt-2" id="modalExistingSvsCollapse">
                            <div class="border rounded p-0" id="modalExistingSvsContainer">
                                <div class="p-2 border-bottom">
                                    <input type="text" class="form-control form-control-sm" id="modalExistingSvsListFilter" placeholder="Фильтр по списку...">
                                </div>
                                <div id="modalExistingSvsPlaceholder" class="text-muted small p-2">Сначала выберите организацию.</div>
                                <div id="modalExistingSvsList" class="list-group list-group-flush small"></div>
                            </div>
                        </div>
                        <div class="form-text">Раскройте список, чтобы выбрать код, или введите новый вручную.</div>
                    </div>
                    <div class="mb-3">
                        <label for="modalSvsCode" class="form-label">Код СВС</label>
                        <input type="text" class="form-control" id="modalSvsCode" placeholder="Введите код СВС">
                    </div>
                    <button type="submit" class="btn btn-primary">Сохранить</button>
                </form>
                <div id="svsCodeFormResult" class="mt-3"></div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        let allData = [];
        let currentDataType = 'consumption';
        let currentOrganizationId = null;
        let organizationSvsCodesCache = new Map();
        let currentOrganizationSvsCodes = [];

        document.addEventListener('DOMContentLoaded', async function () {
            await loadEducationDepartmentsForMapping();
            
            // Обработчик изменения типа данных
            document.querySelectorAll('input[name="dataType"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    currentDataType = this.value;
                    if (currentOrganizationId && document.getElementById('dataDate').value) {
                        loadData();
                    }
                });
            });

            // Обработчик формы сохранения кода СВС
            document.getElementById('saveSvsCodeForm').addEventListener('submit', async function (e) {
                e.preventDefault();
                const recordId = document.getElementById('modalRecordId').value;
                const recordType = document.getElementById('modalRecordType').value;
                const svsCode = document.getElementById('modalSvsCode').value;
                const resultDiv = document.getElementById('svsCodeFormResult');

                try {
                    const endpoint = recordType === 'consumption' 
                        ? `/api/data/consumption/${recordId}/svs-code`
                        : `/api/data/receipts/${recordId}/svs-code`;
                    
                    const response = await api.put(endpoint, { svsCode: svsCode });
                    if (response.success) {
                        resultDiv.innerHTML = `<div class="alert alert-success">${response.message}</div>`;
                        if (currentOrganizationId) {
                            organizationSvsCodesCache.delete(currentOrganizationId);
                        }
                        const modal = bootstrap.Modal.getInstance(document.getElementById('editSvsCodeModal'));
                        modal.hide();
                        await loadData(); // Перезагружаем данные после сохранения
                    } else {
                        resultDiv.innerHTML = `<div class="alert alert-danger">${response.message || 'Ошибка сохранения кода СВС.'}</div>`;
                    }
                } catch (error) {
                    console.error('Ошибка сохранения кода СВС:', error);
                    resultDiv.innerHTML = `<div class="alert alert-danger">Произошла ошибка: ${error.message || 'Неизвестная ошибка.'}</div>`;
                }
            });

            document.getElementById('modalExistingSvsListFilter').addEventListener('input', function () {
                filterExistingSvsCodes(this.value);
            });
        });

        async function loadEducationDepartmentsForMapping() {
            try {
                const response = await api.get('/api/educationdepartments');
                if (response.success) {
                    const departments = response.data;
                    const selectElement = document.getElementById('mappingEducationDepartmentSelect');
                    selectElement.innerHTML = '<option value="">Выберите УО</option>';
                    departments.forEach(dep => {
                        const option = document.createElement('option');
                        option.value = dep.id;
                        option.textContent = `${dep.name} (${dep.city || 'Без города'})`;
                        selectElement.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Ошибка при загрузке УО:', error);
            }
        }

        async function loadOrganizationsForMapping() {
            const educationDepartmentId = document.getElementById('mappingEducationDepartmentSelect').value;
            const selectElement = document.getElementById('mappingOrganizationSelect');
            selectElement.innerHTML = '<option value="">Выберите организацию</option>';
            selectElement.disabled = true;

            if (educationDepartmentId) {
                try {
                    const response = await api.get(`/api/educationdepartments/${educationDepartmentId}/organizations`);
                    if (response.success) {
                        response.data.forEach(org => {
                            const option = document.createElement('option');
                            option.value = org.id;
                            option.textContent = `${org.name} (${org.city || 'Без города'})`;
                            selectElement.appendChild(option);
                        });
                        selectElement.disabled = false;
                    }
                } catch (error) {
                    console.error('Ошибка при загрузке организаций:', error);
                }
            }
        }

        async function loadData() {
            const organizationId = document.getElementById('mappingOrganizationSelect').value;
            const date = document.getElementById('dataDate').value;
            const dataType = document.querySelector('input[name="dataType"]:checked').value;
            
            if (!organizationId) {
                alert('Выберите организацию');
                return;
            }

            currentOrganizationId = organizationId;
            currentDataType = dataType;

            const tableBody = document.getElementById('dataTableBody');
            const tableHeader = document.getElementById('tableHeader');
            tableBody.innerHTML = '<tr><td colspan="10" class="text-center">Загрузка данных...</td></tr>';

            try {
                let url = `/api/data/${dataType}?organizationId=${organizationId}`;
                if (date) {
                    url += `&date=${date}`;
                }
                const response = await api.get(url);

                if (response.success && response.data.length > 0) {
                    allData = response.data;
                    displayData(allData, dataType);
                } else {
                    allData = [];
                    tableBody.innerHTML = '<tr><td colspan="10" class="text-center">Нет данных для выбранных критериев.</td></tr>';
                }
            } catch (error) {
                console.error('Ошибка при загрузке данных:', error);
                tableBody.innerHTML = '<tr><td colspan="10" class="text-center text-danger">Ошибка загрузки данных.</td></tr>';
            }
        }

        function displayData(data, dataType) {
            const tableBody = document.getElementById('dataTableBody');
            const tableHeader = document.getElementById('tableHeader');
            
            tableBody.innerHTML = '';
            
            if (dataType === 'consumption') {
                tableHeader.innerHTML = `
                    <th>Дата</th>
                    <th>Продукт</th>
                    <th>Код продукта</th>
                    <th>Ед. изм.</th>
                    <th>Количество</th>
                    <th>Цена</th>
                    <th>Сумма</th>
                    <th>Категория</th>
                    <th>Код СВС</th>
                    <th>Действия</th>
                `;
                
                data.forEach(item => {
                    const row = tableBody.insertRow();
                    row.insertCell().textContent = new Date(item.date).toLocaleDateString();
                    row.insertCell().textContent = item.productName;
                    row.insertCell().textContent = item.productCode || '';
                    row.insertCell().textContent = item.unit || '';
                    row.insertCell().textContent = item.quantity;
                    row.insertCell().textContent = item.price;
                    row.insertCell().textContent = item.totalCost;
                    row.insertCell().textContent = item.categoryName || '';
                    const svsCodeCell = row.insertCell();
                    svsCodeCell.textContent = item.svsCode || '';
                    if (!item.svsCode) {
                        svsCodeCell.classList.add('text-danger', 'fst-italic');
                        svsCodeCell.textContent = 'Не присвоен';
                    }
                    
                    const actionsCell = row.insertCell();
                    const editBtn = document.createElement('button');
                    editBtn.className = 'btn btn-sm btn-info';
                    editBtn.innerHTML = '<i class="fas fa-edit me-1"></i>Редактировать';
                    editBtn.onclick = () => openEditModal(item.id, 'consumption', item.productName, item.svsCode || '');
                    actionsCell.appendChild(editBtn);
                });
            } else {
                tableHeader.innerHTML = `
                    <th>Дата</th>
                    <th>Номер документа</th>
                    <th>Поставщик</th>
                    <th>Продукт</th>
                    <th>Код продукта</th>
                    <th>Ед. изм.</th>
                    <th>Количество</th>
                    <th>Цена</th>
                    <th>Сумма</th>
                    <th>Код СВС</th>
                    <th>Действия</th>
                `;
                
                data.forEach(item => {
                    const row = tableBody.insertRow();
                    row.insertCell().textContent = new Date(item.date).toLocaleDateString();
                    row.insertCell().textContent = item.documentNumber || '';
                    row.insertCell().textContent = item.supplierName || '';
                    row.insertCell().textContent = item.productName;
                    row.insertCell().textContent = item.productCode || '';
                    row.insertCell().textContent = item.unit || '';
                    row.insertCell().textContent = item.quantity;
                    row.insertCell().textContent = item.price;
                    row.insertCell().textContent = item.totalCost;
                    const svsCodeCell = row.insertCell();
                    svsCodeCell.textContent = item.svsCode || '';
                    if (!item.svsCode) {
                        svsCodeCell.classList.add('text-danger', 'fst-italic');
                        svsCodeCell.textContent = 'Не присвоен';
                    }
                    
                    const actionsCell = row.insertCell();
                    const editBtn = document.createElement('button');
                    editBtn.className = 'btn btn-sm btn-info';
                    editBtn.innerHTML = '<i class="fas fa-edit me-1"></i>Редактировать';
                    editBtn.onclick = () => openEditModal(item.id, 'receipts', item.productName, item.svsCode || '');
                    actionsCell.appendChild(editBtn);
                });
            }
        }

        async function openEditModal(recordId, recordType, productName, currentSvsCode) {
            document.getElementById('modalRecordId').value = recordId;
            document.getElementById('modalRecordType').value = recordType;
            document.getElementById('modalProductName').value = productName;
            document.getElementById('modalSvsCode').value = currentSvsCode;
            document.getElementById('svsCodeFormResult').innerHTML = '';
            document.getElementById('modalExistingSvsListFilter').value = '';
            document.getElementById('modalExistingSvsSelectedText').textContent = currentSvsCode ? `Текущий код: ${currentSvsCode}` : 'Показать список кодов';
            const collapseElement = document.getElementById('modalExistingSvsCollapse');
            if (collapseElement.classList.contains('show')) {
                bootstrap.Collapse.getInstance(collapseElement)?.hide();
            }

            await populateExistingSvsCodes(currentOrganizationId, currentSvsCode);
            
            const modal = new bootstrap.Modal(document.getElementById('editSvsCodeModal'));
            modal.show();
        }

        function filterData() {
            const searchInput = document.getElementById('mappingSearchInput').value.toLowerCase();
            const filtered = allData.filter(item =>
                item.productName.toLowerCase().includes(searchInput) ||
                (item.productCode && item.productCode.toLowerCase().includes(searchInput)) ||
                (item.svsCode && item.svsCode.toLowerCase().includes(searchInput))
            );
            displayData(filtered, currentDataType);
        }

        async function populateExistingSvsCodes(organizationId, currentSvsCode) {
            const listElement = document.getElementById('modalExistingSvsList');
            const placeholder = document.getElementById('modalExistingSvsPlaceholder');

            if (!organizationId) {
                listElement.innerHTML = '';
                placeholder.textContent = 'Сначала выберите организацию.';
                placeholder.classList.remove('d-none');
                currentOrganizationSvsCodes = [];
                return;
            }

            listElement.innerHTML = '';
            placeholder.textContent = 'Загрузка...';
            placeholder.classList.remove('d-none');

            try {
                const svsCodes = await loadOrganizationSvsCodes(organizationId);
                currentOrganizationSvsCodes = svsCodes;

                if (svsCodes.length === 0) {
                    placeholder.textContent = 'Нет сохраненных кодов.';
                    return;
                }

                placeholder.classList.add('d-none');
                renderExistingSvsOptions(svsCodes, currentSvsCode);
            } catch (error) {
                console.error('Ошибка при загрузке кодов СВС организации:', error);
                listElement.innerHTML = '';
                placeholder.textContent = 'Ошибка загрузки кодов СВС.';
                placeholder.classList.remove('d-none');
            }
        }

        function renderExistingSvsOptions(codes, currentSvsCode) {
            const listElement = document.getElementById('modalExistingSvsList');
            const placeholder = document.getElementById('modalExistingSvsPlaceholder');
            const selectedText = document.getElementById('modalExistingSvsSelectedText');

            listElement.innerHTML = '';
            placeholder.classList.toggle('d-none', codes.length > 0);
            const normalizedCurrent = (currentSvsCode || '').toLowerCase();

            codes.forEach(entry => {
                const button = document.createElement('button');
                button.type = 'button';
                button.className = 'list-group-item list-group-item-action';
                button.dataset.svsCode = entry.svsCode;
                button.innerHTML = `
                    <div class="fw-semibold">${entry.svsCode}</div>
                    <div class="text-muted small">${entry.productName}${entry.productCode ? ` (${entry.productCode})` : ''}</div>
                `;

                if (entry.svsCode.toLowerCase() === normalizedCurrent) {
                    button.classList.add('active');
                    selectedText.textContent = `Выбранный код: ${entry.svsCode}`;
                }

                button.addEventListener('click', () => {
                    document.getElementById('modalSvsCode').value = entry.svsCode;
                    selectedText.textContent = `Выбранный код: ${entry.svsCode}`;
                    Array.from(listElement.children).forEach(item => item.classList.remove('active'));
                    button.classList.add('active');
                });

                listElement.appendChild(button);
            });
        }

        function filterExistingSvsCodes(query) {
            const normalizedQuery = query.trim().toLowerCase();

            if (!normalizedQuery) {
                renderExistingSvsOptions(currentOrganizationSvsCodes, document.getElementById('modalSvsCode').value);
                return;
            }

            const filtered = currentOrganizationSvsCodes.filter(entry =>
                entry.svsCode.toLowerCase().includes(normalizedQuery) ||
                entry.productName.toLowerCase().includes(normalizedQuery) ||
                (entry.productCode && entry.productCode.toLowerCase().includes(normalizedQuery))
            );

            renderExistingSvsOptions(filtered, document.getElementById('modalSvsCode').value);
        }

        async function loadOrganizationSvsCodes(organizationId) {
            if (organizationSvsCodesCache.has(organizationId)) {
                return organizationSvsCodesCache.get(organizationId);
            }

            const response = await api.get(`/api/organizationproducts?organizationId=${organizationId}`);

            if (!response.success || !Array.isArray(response.data)) {
                return [];
            }

            const codes = response.data
                .filter(item => item.svsCode)
                .map(item => ({
                    svsCode: item.svsCode,
                    productName: item.product?.name || 'Без названия',
                    productCode: item.product?.code || ''
                }))
                .sort((a, b) => a.productName.localeCompare(b.productName, 'ru', { sensitivity: 'base' }));

            organizationSvsCodesCache.set(organizationId, codes);
            return codes;
        }

        function downloadExport() {
            const organizationId = document.getElementById('mappingOrganizationSelect').value;
            const educationDepartmentId = document.getElementById('mappingEducationDepartmentSelect').value;
            const type = document.querySelector('input[name="dataType"]:checked').value;
            const date = document.getElementById('dataDate').value;

            if (!organizationId) {
                alert('Выберите организацию');
                return;
            }

            const params = new URLSearchParams();
            params.append('organizationId', organizationId);
            
            // Если дата указана, используем её, иначе выгружаем за все даты
            if (date) {
                params.append('from', date);
                params.append('to', date);
            }

            const url = `/api/exports/${type}?${params.toString()}`;
            window.location.href = url;
        }
    </script>
}
