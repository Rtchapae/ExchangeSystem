@{
    ViewData["Title"] = "Сопоставление данных";
}

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h3 class="card-title mb-0">
                        <i class="fas fa-exchange-alt me-2"></i>Сопоставление внутренних продуктов с материалами СВС
                    </h3>
                </div>
                <div class="card-body">
                    <p>На этой странице вы можете сопоставлять продукты вашей системы с материалами из справочника СВС. Сопоставление может быть применено ко всем организациям в рамках выбранного УО или к конкретной организации.</p>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="mappingEducationDepartmentSelect" class="form-label">Выберите УО (опционально)</label>
                            <select class="form-select" id="mappingEducationDepartmentSelect" onchange="loadOrganizationsForMapping()">
                                <option value="">Все УО</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="mappingOrganizationSelect" class="form-label">Выберите Организацию (опционально)</label>
                            <select class="form-select" id="mappingOrganizationSelect" onchange="loadMappings()">
                                <option value="">Все организации</option>
                            </select>
                        </div>
                    </div>

                    <div class="mb-3">
                        <input type="text" class="form-control" id="mappingSearchInput" placeholder="Поиск по названию продукта или коду СВС..." onkeyup="filterMappings()">
                    </div>

                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>Название продукта</th>
                                    <th>Код продукта</th>
                                    <th>Категория</th>
                                    <th>Ед. изм.</th>
                                    <th>Сопоставленный СВС материал</th>
                                    <th>Код СВС</th>
                                    <th>Уверенность</th>
                                    <th>Действия</th>
                                </tr>
                            </thead>
                            <tbody id="mappingsTableBody">
                                <tr><td colspan="8" class="text-center">Выберите УО или организацию для просмотра сопоставлений.</td></tr>
                            </tbody>
                        </table>
                    </div>

                    <div class="d-flex justify-content-between mt-3">
                        <button class="btn btn-success" id="exportMappingsBtn">Экспортировать сопоставления в JSON</button>
                    </div>

                    <pre id="exportJsonDisplay" class="bg-light p-3 rounded mt-3" style="max-height: 400px; overflow-y: auto; display: none;"></pre>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Mapping Modal -->
<div class="modal fade" id="mappingModal" tabindex="-1" aria-labelledby="mappingModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="mappingModalLabel">Сопоставить продукт</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="saveMappingForm">
                    <input type="hidden" id="modalProductId">
                    <p><strong>Продукт:</strong> <span id="modalProductName"></span> (<span id="modalProductCode"></span>)</p>
                    <div class="mb-3">
                        <label for="modalSvsMaterialSelect" class="form-label">Выберите материал СВС</label>
                        <select class="form-select" id="modalSvsMaterialSelect" required>
                            <option value="">Выберите материал</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="modalSvsCode" class="form-label">Код СВС (для экспорта)</label>
                        <input type="text" class="form-control" id="modalSvsCode" readonly>
                    </div>
                    <div class="mb-3">
                        <label for="modalMappingNotes" class="form-label">Примечания</label>
                        <input type="text" class="form-control" id="modalMappingNotes">
                    </div>
                    <button type="submit" class="btn btn-primary">Сохранить сопоставление</button>
                </form>
                <div id="mappingFormResult" class="mt-3"></div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        let allMappings = [];
        let allSvsMaterials = [];

        document.addEventListener('DOMContentLoaded', async function () {
            await loadEducationDepartmentsForMapping();
            await loadSvsMaterialsForModal(); // Load all SVS materials once for the modal

            document.getElementById('exportMappingsBtn').addEventListener('click', async function () {
                const educationDepartmentId = document.getElementById('mappingEducationDepartmentSelect').value;
                const organizationId = document.getElementById('mappingOrganizationSelect').value;
                const resultDiv = document.getElementById('exportResult');
                const jsonDisplay = document.getElementById('exportJsonDisplay');
                resultDiv.innerHTML = '<div class="alert alert-info">Экспорт сопоставлений...</div>';
                jsonDisplay.style.display = 'none';

                try {
                    const url = `/api/svs/export?educationDepartmentId=${educationDepartmentId}&organizationId=${organizationId}`;
                    const response = await api.get(url);
                    if (response.success) {
                        resultDiv.innerHTML = `<div class="alert alert-success">Сопоставления успешно экспортированы.</div>`;
                        jsonDisplay.textContent = JSON.stringify(response.data, null, 2);
                        jsonDisplay.style.display = 'block';
                    } else {
                        resultDiv.innerHTML = `<div class="alert alert-danger">${response.message || 'Ошибка при экспорте сопоставлений.'}</div>`;
                    }
                } catch (error) {
                    console.error('Ошибка при экспорте сопоставлений:', error);
                    resultDiv.innerHTML = `<div class="alert alert-danger">Произошла ошибка: ${error.message || 'Неизвестная ошибка.'}</div>`;
                }
            });

            document.getElementById('saveMappingForm').addEventListener('submit', async function (e) {
                e.preventDefault();
                const productId = document.getElementById('modalProductId').value;
                const svsMatId = document.getElementById('modalSvsMaterialSelect').value;
                const svsCode = document.getElementById('modalSvsCode').value;
                const mappingNotes = document.getElementById('modalMappingNotes').value;
                const educationDepartmentId = document.getElementById('mappingEducationDepartmentSelect').value;
                const organizationId = document.getElementById('mappingOrganizationSelect').value;
                const resultDiv = document.getElementById('mappingFormResult');

                const payload = {
                    productId: parseInt(productId),
                    svsMatId: parseInt(svsMatId),
                    svsCode: svsCode,
                    notes: mappingNotes,
                    educationDepartmentId: educationDepartmentId ? parseInt(educationDepartmentId) : null,
                    organizationId: organizationId ? parseInt(organizationId) : null
                };

                try {
                    const response = await api.post('/api/svs/mappings', payload);
                    if (response.success) {
                        resultDiv.innerHTML = `<div class="alert alert-success">${response.message}</div>`;
                        const modal = bootstrap.Modal.getInstance(document.getElementById('mappingModal'));
                        modal.hide();
                        await loadMappings(); // Reload mappings after saving
                    } else {
                        resultDiv.innerHTML = `<div class="alert alert-danger">${response.message || 'Ошибка сохранения сопоставления.'}</div>`;
                    }
                } catch (error) {
                    console.error('Ошибка сохранения сопоставления:', error);
                    resultDiv.innerHTML = `<div class="alert alert-danger">Произошла ошибка: ${error.message || 'Неизвестная ошибка.'}</div>`;
                }
            });

            document.getElementById('modalSvsMaterialSelect').addEventListener('change', function() {
                const selectedSvsMatId = this.value;
                const selectedSvsMaterial = allSvsMaterials.find(m => m.matId == selectedSvsMatId);
                document.getElementById('modalSvsCode').value = selectedSvsMaterial ? selectedSvsMaterial.matId : '';
            });
        });

        async function loadEducationDepartmentsForMapping() {
            try {
                const response = await api.get('/api/educationdepartments');
                if (response.success) {
                    const departments = response.data;
                    const selectElement = document.getElementById('mappingEducationDepartmentSelect');
                    selectElement.innerHTML = '<option value="">Все УО</option>';
                    departments.forEach(dep => {
                        const option = document.createElement('option');
                        option.value = dep.id;
                        option.textContent = `${dep.name} (${dep.city || 'Без города'})`;
                        selectElement.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Ошибка при загрузке УО для сопоставления:', error);
            }
        }

        async function loadOrganizationsForMapping() {
            const educationDepartmentId = document.getElementById('mappingEducationDepartmentSelect').value;
            const selectElement = document.getElementById('mappingOrganizationSelect');
            selectElement.innerHTML = '<option value="">Все организации</option>'; // Reset organizations

            if (educationDepartmentId) {
                try {
                    const response = await api.get(`/api/educationdepartments/${educationDepartmentId}/organizations`);
                    if (response.success) {
                        response.data.forEach(org => {
                            const option = document.createElement('option');
                            option.value = org.id;
                            option.textContent = `${org.name} (${org.city || 'Без города'})`;
                            selectElement.appendChild(option);
                        });
                    }
                } catch (error) {
                    console.error('Ошибка при загрузке организаций для УО:', error);
                }
            }
            await loadMappings(); // Reload mappings when organization selection changes
        }

        async function loadMappings() {
            const educationDepartmentId = document.getElementById('mappingEducationDepartmentSelect').value;
            const organizationId = document.getElementById('mappingOrganizationSelect').value;
            const tableBody = document.getElementById('mappingsTableBody');
            tableBody.innerHTML = '<tr><td colspan="8" class="text-center">Загрузка сопоставлений...</td></tr>';

            try {
                const url = `/api/svs/mappings?educationDepartmentId=${educationDepartmentId}&organizationId=${organizationId}`;
                const response = await api.get(url);

                if (response.success && response.data.length > 0) {
                    allMappings = response.data;
                    displayMappings(allMappings);
                } else {
                    allMappings = [];
                    tableBody.innerHTML = '<tr><td colspan="8" class="text-center">Нет сопоставлений для выбранных критериев.</td></tr>';
                }
            } catch (error) {
                console.error('Ошибка при загрузке сопоставлений:', error);
                tableBody.innerHTML = '<tr><td colspan="8" class="text-center text-danger">Ошибка загрузки сопоставлений.</td></tr>';
            }
        }

        function displayMappings(mappings) {
            const tableBody = document.getElementById('mappingsTableBody');
            tableBody.innerHTML = '';

            if (mappings.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="8" class="text-center">Нет сопоставлений для отображения.</td></tr>';
                return;
            }

            mappings.forEach(mapping => {
                const row = tableBody.insertRow();
                row.insertCell().textContent = mapping.productName;
                row.insertCell().textContent = mapping.productCode;
                row.insertCell().textContent = mapping.productCategory;
                row.insertCell().textContent = mapping.productUnit;
                row.insertCell().textContent = mapping.svsName || 'Не сопоставлено';
                row.insertCell().textContent = mapping.svsCode || '';
                row.insertCell().textContent = (mapping.confidence * 100).toFixed(0) + '%';

                const actionsCell = row.insertCell();
                const editBtn = document.createElement('button');
                editBtn.className = 'btn btn-sm btn-info';
                editBtn.textContent = 'Редактировать';
                editBtn.onclick = () => openMappingModal(mapping);
                actionsCell.appendChild(editBtn);

                if (!mapping.svsCode) {
                    row.classList.add('table-warning'); // Highlight unmapped rows
                }
            });
        }

        async function loadSvsMaterialsForModal() {
            // This endpoint needs to be created to fetch all SVS materials
            // For now, we'll use a placeholder or assume they are loaded with mappings
            // In a real scenario, you'd have an API like /api/svs/all-materials
            try {
                const response = await api.get('/api/svs/materials-list'); // Assuming a new endpoint
                if (response.success) {
                    allSvsMaterials = response.data;
                    const selectElement = document.getElementById('modalSvsMaterialSelect');
                    selectElement.innerHTML = '<option value="">Выберите материал</option>';
                    allSvsMaterials.forEach(mat => {
                        const option = document.createElement('option');
                        option.value = mat.matId;
                        option.textContent = `${mat.nameMat} (${mat.nameMeasure})`;
                        selectElement.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Ошибка при загрузке материалов СВС для модального окна:', error);
            }
        }

        function openMappingModal(mapping) {
            document.getElementById('modalProductId').value = mapping.productId;
            document.getElementById('modalProductName').textContent = mapping.productName;
            document.getElementById('modalProductCode').textContent = mapping.productCode;
            document.getElementById('modalMappingNotes').value = mapping.mappingNotes || '';

            const svsMaterialSelect = document.getElementById('modalSvsMaterialSelect');
            svsMaterialSelect.value = mapping.svsMatId || '';
            document.getElementById('modalSvsCode').value = mapping.svsCode || '';

            const modal = new bootstrap.Modal(document.getElementById('mappingModal'));
            modal.show();
        }

        function filterMappings() {
            const searchInput = document.getElementById('mappingSearchInput').value.toLowerCase();
            const filtered = allMappings.filter(mapping =>
                mapping.productName.toLowerCase().includes(searchInput) ||
                mapping.productCode.toLowerCase().includes(searchInput) ||
                (mapping.svsName && mapping.svsName.toLowerCase().includes(searchInput)) ||
                (mapping.svsCode && mapping.svsCode.toLowerCase().includes(searchInput))
            );
            displayMappings(filtered);
        }
    </script>
}
