@{
    ViewData["Title"] = "УО и организации";
}

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h3 class="card-title mb-0">
                        <i class="fas fa-building me-2"></i>Управления образования (УО) и привязанные организации
                    </h3>
                </div>
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#educationDepartmentModal" onclick="openEducationDepartmentModal()">
                                <i class="fas fa-plus me-2"></i>Добавить УО
                            </button>
                        </div>
                        <div class="col-md-6 text-end">
                            <span class="badge bg-info fs-6" id="uoCount">УО: 0</span>
                        </div>
                    </div>

                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>Название УО</th>
                                    <th>Город</th>
                                    <th>Адрес</th>
                                    <th>Директор</th>
                                    <th>Активно</th>
                                    <th>Действия</th>
                                </tr>
                            </thead>
                            <tbody id="educationDepartmentsTableBody">
                                <tr><td colspan="6" class="text-center">Загрузка...</td></tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Пагинация для УО -->
                    <nav aria-label="Пагинация УО">
                        <ul class="pagination justify-content-center" id="educationDepartmentsPagination">
                            <!-- Пагинация будет добавлена динамически -->
                        </ul>
                    </nav>

                    <h4 class="mt-4">Организации в выбранном УО</h4>
                    <div class="row mb-3">
                        <div class="col-md-6">
                        <label for="selectedEducationDepartment" class="form-label">Выберите УО для просмотра организаций</label>
                        <select class="form-select" id="selectedEducationDepartment" onchange="currentOrganizationsPage = 1; loadOrganizationsForSelectedDepartment(1)">
                            <option value="">Выберите УО</option>
                        </select>
                        </div>
                        <div class="col-md-6 d-flex align-items-end">
                            <button class="btn btn-success" id="addOrganizationBtn" data-bs-toggle="modal" data-bs-target="#organizationModal" onclick="openOrganizationModal()" disabled>
                                <i class="fas fa-plus me-2"></i>Добавить организацию
                            </button>
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-bordered table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>Название организации</th>
                                    <th>Город</th>
                                    <th>Адрес</th>
                                    <th>Телефон</th>
                                    <th>Менеджер</th>
                                    <th>Действия</th>
                                </tr>
                            </thead>
                            <tbody id="organizationsTableBody">
                                <tr><td colspan="6" class="text-center">Выберите УО для просмотра организаций.</td></tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Пагинация для организаций -->
                    <nav aria-label="Пагинация организаций">
                        <ul class="pagination justify-content-center" id="organizationsPagination">
                            <!-- Пагинация будет добавлена динамически -->
                        </ul>
                    </nav>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Education Department Modal -->
<div class="modal fade" id="educationDepartmentModal" tabindex="-1" aria-labelledby="educationDepartmentModalLabel" aria-hidden="true" data-bs-backdrop="true" data-bs-keyboard="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="educationDepartmentModalLabel">Добавить/Редактировать УО</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" onclick="handleModalClose()"></button>
            </div>
            <div class="modal-body">
                <form id="educationDepartmentForm">
                    <input type="hidden" id="educationDepartmentId">
                    <div class="mb-3">
                        <label for="educationDepartmentName" class="form-label">Название УО *</label>
                        <input type="text" class="form-control" id="educationDepartmentName" required>
                    </div>
                    <div class="mb-3">
                        <label for="educationDepartmentCity" class="form-label">Город</label>
                        <input type="text" class="form-control" id="educationDepartmentCity">
                    </div>
                    <div class="mb-3">
                        <label for="educationDepartmentAddress" class="form-label">Адрес</label>
                        <input type="text" class="form-control" id="educationDepartmentAddress">
                    </div>
                    <div class="mb-3">
                        <label for="educationDepartmentPhone" class="form-label">Телефон</label>
                        <input type="text" class="form-control" id="educationDepartmentPhone">
                    </div>
                    <div class="mb-3">
                        <label for="educationDepartmentEmail" class="form-label">Email</label>
                        <input type="email" class="form-control" id="educationDepartmentEmail">
                    </div>
                    <div class="mb-3">
                        <label for="educationDepartmentDirector" class="form-label">Имя директора</label>
                        <input type="text" class="form-control" id="educationDepartmentDirector">
                    </div>
                    <button type="submit" class="btn btn-primary">Сохранить</button>
                </form>
                <div id="educationDepartmentFormResult" class="mt-3"></div>
            </div>
        </div>
    </div>
</div>

<!-- Organization Modal -->
<div class="modal fade" id="organizationModal" tabindex="-1" aria-labelledby="organizationModalLabel" aria-hidden="true" data-bs-backdrop="true" data-bs-keyboard="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="organizationModalLabel">Добавить/Редактировать организацию</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" onclick="handleOrganizationModalClose()"></button>
            </div>
            <div class="modal-body">
                <form id="organizationForm">
                    <input type="hidden" id="organizationId">
                    <input type="hidden" id="organizationEducationDepartmentId">
                    <div class="mb-3">
                        <label for="organizationName" class="form-label">Название организации *</label>
                        <input type="text" class="form-control" id="organizationName" required>
                    </div>
                    <div class="mb-3">
                        <label for="organizationCity" class="form-label">Город</label>
                        <input type="text" class="form-control" id="organizationCity">
                    </div>
                    <div class="mb-3">
                        <label for="organizationAddress" class="form-label">Адрес</label>
                        <input type="text" class="form-control" id="organizationAddress">
                    </div>
                    <div class="mb-3">
                        <label for="organizationPhone" class="form-label">Телефон</label>
                        <input type="text" class="form-control" id="organizationPhone">
                    </div>
                    <div class="mb-3">
                        <label for="organizationEmail" class="form-label">Менеджер</label>
                        <input type="text" class="form-control" id="organizationEmail">
                    </div>
                    <button type="submit" class="btn btn-primary">Сохранить</button>
                </form>
                <div id="organizationFormResult" class="mt-3"></div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Переменные для пагинации
        let currentEducationDepartmentsPage = 1;
        let currentOrganizationsPage = 1;
        const itemsPerPage = 10;
        let allEducationDepartments = [];
        let allOrganizations = [];

        document.addEventListener('DOMContentLoaded', async function () {
            console.log('DOMContentLoaded: начало выполнения');
            
            // Принудительно очищаем кэш для отладки
            if ('caches' in window) {
                const cacheNames = await caches.keys();
                await Promise.all(cacheNames.map(name => caches.delete(name)));
                console.log('Кэш очищен');
            }
            
            // Проверяем аутентификацию
            const token = localStorage.getItem('authToken') || localStorage.getItem('token');
            console.log('Токен аутентификации:', token ? 'найден' : 'не найден');
            
            // Проверяем, что api доступен, если нет - создаем
            if (typeof window.api === 'undefined') {
                console.error('API не определен! Проверяем ApiClient...');
                if (typeof ApiClient === 'undefined') {
                    console.error('ApiClient не определен! Перезагрузите страницу.');
                    return;
                }
                console.log('Создаем новый экземпляр ApiClient...');
                window.api = new ApiClient();
            }
            console.log('API доступен:', window.api);
            
            console.log('DOMContentLoaded: вызываем loadEducationDepartments');
            
            // Проверяем, что API доступен
            if (typeof window.api === 'undefined' && typeof ApiClient !== 'undefined') {
                window.api = new ApiClient();
            }
            
            await loadEducationDepartments();

            document.getElementById('educationDepartmentForm').addEventListener('submit', async function (e) {
                e.preventDefault();
                const id = document.getElementById('educationDepartmentId').value;
                const name = document.getElementById('educationDepartmentName').value;
                const city = document.getElementById('educationDepartmentCity').value;
                const address = document.getElementById('educationDepartmentAddress').value;
                const phone = document.getElementById('educationDepartmentPhone').value;
                const email = document.getElementById('educationDepartmentEmail').value;
                const directorName = document.getElementById('educationDepartmentDirector').value;
                const resultDiv = document.getElementById('educationDepartmentFormResult');

                const payload = { name, city, address, phone, email, directorName, isActive: true };
                console.log('Отправляем данные:', payload);

                try {
                    if (typeof window.api === 'undefined') {
                        console.error('API не определен в обработчике формы! Создаем новый экземпляр...');
                        window.api = new ApiClient();
                    }
                    
                    let response;
                    if (id) {
                        console.log('Обновляем УО с ID:', id);
                        response = await window.api.put(`/educationdepartments/${id}`, payload);
                    } else {
                        console.log('Создаем новое УО');
                        response = await window.api.post('/educationdepartments', payload);
                    }
                    console.log('Получен ответ:', response);

                    if (response.success) {
                        resultDiv.innerHTML = `<div class="alert alert-success">${response.message}</div>`;
                        
                        // Закрываем модальное окно правильно
                            const modalElement = document.getElementById('educationDepartmentModal');
                        const modal = bootstrap.Modal.getInstance(modalElement);
                        
                        // Принудительно закрываем модальное окно
                                modalElement.classList.remove('show');
                                modalElement.style.display = 'none';
                        modalElement.setAttribute('aria-hidden', 'true');
                        modalElement.removeAttribute('aria-modal');
                        
                        // Удаляем backdrop и восстанавливаем body
                                document.body.classList.remove('modal-open');
                        document.body.style.overflow = '';
                        document.body.style.paddingRight = '';
                        
                        // Удаляем все backdrop элементы
                        const backdrops = document.querySelectorAll('.modal-backdrop');
                        backdrops.forEach(backdrop => backdrop.remove());
                        
                        // Очищаем форму после успешного сохранения
                        setTimeout(() => {
                            document.getElementById('educationDepartmentForm').reset();
                            document.getElementById('educationDepartmentFormResult').innerHTML = '';
                        }, 500);
                        
                        currentEducationDepartmentsPage = 1;
                        await loadEducationDepartments(1);
                    } else {
                        resultDiv.innerHTML = `<div class="alert alert-danger">${response.message || 'Ошибка сохранения.'}</div>`;
                    }
                } catch (error) {
                    console.error('Ошибка сохранения УО:', error);
                    resultDiv.innerHTML = `<div class="alert alert-danger">Произошла ошибка: ${error.message || 'Неизвестная ошибка.'}</div>`;
                }
            });
        });

        async function loadEducationDepartments(page = 1) {
            console.log('loadEducationDepartments: начало выполнения, страница:', page);
            try {
                if (typeof window.api === 'undefined') {
                    console.error('API не определен в loadEducationDepartments! Создаем новый экземпляр...');
                    window.api = new ApiClient();
                }
                console.log('loadEducationDepartments: отправляем запрос к API /educationdepartments');
                const response = await window.api.get('/educationdepartments');
                console.log('loadEducationDepartments: получен ответ:', response);
                console.log('loadEducationDepartments: success =', response.success);
                console.log('loadEducationDepartments: data length =', response.data ? response.data.length : 'undefined');
                
                const tableBody = document.getElementById('educationDepartmentsTableBody');
                const selectElement = document.getElementById('selectedEducationDepartment');
                console.log('loadEducationDepartments: элементы найдены:', { tableBody, selectElement });
                
                tableBody.innerHTML = '';
                selectElement.innerHTML = '<option value="">Выберите УО</option>';

                if (response.success && response.data.length > 0) {
                    console.log('loadEducationDepartments: обрабатываем данные, количество:', response.data.length);
                    
                    // Сохраняем все данные для пагинации
                    allEducationDepartments = response.data;
                    
                    // Обновляем счетчик УО
                    const uoCountElement = document.getElementById('uoCount');
                    if (uoCountElement) {
                        uoCountElement.textContent = `УО: ${response.data.length}`;
                    }
                    
                    // Вычисляем пагинацию
                    const totalPages = Math.ceil(response.data.length / itemsPerPage);
                    const startIndex = (page - 1) * itemsPerPage;
                    const endIndex = Math.min(startIndex + itemsPerPage, response.data.length);
                    const pageData = response.data.slice(startIndex, endIndex);
                    
                    // Отображаем данные для текущей страницы
                    pageData.forEach(dep => {
                        console.log('loadEducationDepartments: добавляем строку для УО:', dep.name);
                        const row = tableBody.insertRow();
                        row.insertCell().textContent = dep.name;
                        row.insertCell().textContent = dep.city || '';
                        row.insertCell().textContent = dep.address || '';
                        row.insertCell().textContent = dep.directorName || '';
                        row.insertCell().textContent = dep.isActive ? 'Да' : 'Нет';

                        const actionsCell = row.insertCell();
                        const editBtn = document.createElement('button');
                        editBtn.className = 'btn btn-sm btn-info me-2';
                        editBtn.textContent = 'Редактировать';
                        editBtn.onclick = () => openEducationDepartmentModal(dep);
                        actionsCell.appendChild(editBtn);

                        const deleteBtn = document.createElement('button');
                        deleteBtn.className = 'btn btn-sm btn-danger';
                        deleteBtn.textContent = 'Удалить';
                        deleteBtn.onclick = () => deleteEducationDepartment(dep.id);
                        actionsCell.appendChild(deleteBtn);

                        const option = document.createElement('option');
                        option.value = dep.id;
                        option.textContent = `${dep.name} (${dep.city || 'Без города'})`;
                        selectElement.appendChild(option);
                    });
                    
                    // Обновляем пагинацию
                    updateEducationDepartmentsPagination(page, totalPages);
                } else {
                    console.log('loadEducationDepartments: нет данных или ошибка в ответе');
                    tableBody.innerHTML = '<tr><td colspan="6" class="text-center">Нет данных об УО.</td></tr>';
                    // Обновляем счетчик УО
                    const uoCountElement = document.getElementById('uoCount');
                    if (uoCountElement) {
                        uoCountElement.textContent = 'УО: 0';
                    }
                    // Очищаем пагинацию
                    document.getElementById('educationDepartmentsPagination').innerHTML = '';
                }
            } catch (error) {
                console.error('Ошибка при загрузке УО:', error);
                document.getElementById('educationDepartmentsTableBody').innerHTML = '<tr><td colspan="6" class="text-center text-danger">Ошибка загрузки УО.</td></tr>';
            }
        }

        // Функция для обновления пагинации УО
        function updateEducationDepartmentsPagination(currentPage, totalPages) {
            const pagination = document.getElementById('educationDepartmentsPagination');
            pagination.innerHTML = '';

            if (totalPages <= 1) return;

            // Кнопка "Предыдущая"
            const prevLi = document.createElement('li');
            prevLi.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
            const prevLink = document.createElement('a');
            prevLink.className = 'page-link';
            prevLink.href = '#';
            prevLink.textContent = 'Предыдущая';
            prevLink.onclick = (e) => {
                e.preventDefault();
                if (currentPage > 1) {
                    currentEducationDepartmentsPage = currentPage - 1;
                    loadEducationDepartments(currentEducationDepartmentsPage);
                }
            };
            prevLi.appendChild(prevLink);
            pagination.appendChild(prevLi);

            // Номера страниц
            const startPage = Math.max(1, currentPage - 2);
            const endPage = Math.min(totalPages, currentPage + 2);

            for (let i = startPage; i <= endPage; i++) {
                const li = document.createElement('li');
                li.className = `page-item ${i === currentPage ? 'active' : ''}`;
                const link = document.createElement('a');
                link.className = 'page-link';
                link.href = '#';
                link.textContent = i;
                link.onclick = (e) => {
                    e.preventDefault();
                    currentEducationDepartmentsPage = i;
                    loadEducationDepartments(currentEducationDepartmentsPage);
                };
                li.appendChild(link);
                pagination.appendChild(li);
            }

            // Кнопка "Следующая"
            const nextLi = document.createElement('li');
            nextLi.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
            const nextLink = document.createElement('a');
            nextLink.className = 'page-link';
            nextLink.href = '#';
            nextLink.textContent = 'Следующая';
            nextLink.onclick = (e) => {
                e.preventDefault();
                if (currentPage < totalPages) {
                    currentEducationDepartmentsPage = currentPage + 1;
                    loadEducationDepartments(currentEducationDepartmentsPage);
                }
            };
            nextLi.appendChild(nextLink);
            pagination.appendChild(nextLi);
        }

        // Функция для обработки закрытия модального окна
        function handleModalHidden() {
            // Очищаем форму при закрытии
            const form = document.getElementById('educationDepartmentForm');
            form.reset();
            document.getElementById('educationDepartmentFormResult').innerHTML = '';
            
            // Принудительно удаляем все backdrop элементы
            const backdrops = document.querySelectorAll('.modal-backdrop');
            backdrops.forEach(backdrop => backdrop.remove());
            
            // Восстанавливаем body
            document.body.classList.remove('modal-open');
            document.body.style.overflow = '';
            document.body.style.paddingRight = '';
            
            // Дополнительная очистка через небольшую задержку
            setTimeout(() => {
                const remainingBackdrops = document.querySelectorAll('.modal-backdrop');
                remainingBackdrops.forEach(backdrop => backdrop.remove());
                
                if (document.body.classList.contains('modal-open')) {
                    document.body.classList.remove('modal-open');
                    document.body.style.overflow = '';
                    document.body.style.paddingRight = '';
                }
            }, 100);
        }

        // Функция для обработки закрытия модального окна через кнопку
        function handleModalClose() {
            const modalElement = document.getElementById('educationDepartmentModal');
            
            // Принудительно закрываем модальное окно
            modalElement.classList.remove('show');
            modalElement.style.display = 'none';
            modalElement.setAttribute('aria-hidden', 'true');
            modalElement.removeAttribute('aria-modal');
            
            // Удаляем backdrop и восстанавливаем body
            document.body.classList.remove('modal-open');
            document.body.style.overflow = '';
            document.body.style.paddingRight = '';
            
            // Удаляем все backdrop элементы
            const backdrops = document.querySelectorAll('.modal-backdrop');
            backdrops.forEach(backdrop => backdrop.remove());
            
            // Дополнительная очистка
            setTimeout(() => {
                const remainingBackdrops = document.querySelectorAll('.modal-backdrop');
                remainingBackdrops.forEach(backdrop => backdrop.remove());
                
                if (document.body.classList.contains('modal-open')) {
                    document.body.classList.remove('modal-open');
                    document.body.style.overflow = '';
                    document.body.style.paddingRight = '';
                }
            }, 100);
        }

        function openEducationDepartmentModal(dep = null) {
            // Очищаем все возможные backdrop элементы перед открытием
            const existingBackdrops = document.querySelectorAll('.modal-backdrop');
            existingBackdrops.forEach(backdrop => backdrop.remove());
            
            // Восстанавливаем body
            document.body.classList.remove('modal-open');
            document.body.style.overflow = '';
            document.body.style.paddingRight = '';
            
            const modalLabel = document.getElementById('educationDepartmentModalLabel');
            const form = document.getElementById('educationDepartmentForm');
            form.reset();
            document.getElementById('educationDepartmentFormResult').innerHTML = '';

            if (dep) {
                modalLabel.textContent = 'Редактировать УО';
                document.getElementById('educationDepartmentId').value = dep.id;
                document.getElementById('educationDepartmentName').value = dep.name;
                document.getElementById('educationDepartmentCity').value = dep.city || '';
                document.getElementById('educationDepartmentAddress').value = dep.address || '';
                document.getElementById('educationDepartmentPhone').value = dep.phone || '';
                document.getElementById('educationDepartmentEmail').value = dep.email || '';
                document.getElementById('educationDepartmentDirector').value = dep.directorName || '';
            } else {
                modalLabel.textContent = 'Добавить УО';
                document.getElementById('educationDepartmentId').value = '';
            }
            
            const modalElement = document.getElementById('educationDepartmentModal');
            
            // Удаляем старые обработчики событий
            modalElement.removeEventListener('hidden.bs.modal', handleModalHidden);
            
            // Добавляем обработчик для правильного закрытия модального окна
            modalElement.addEventListener('hidden.bs.modal', handleModalHidden);
            
            const modal = new bootstrap.Modal(modalElement);
            modal.show();
        }

        async function deleteEducationDepartment(id) {
            if (!confirm('Вы уверены, что хотите удалить это УО?')) {
                return;
            }
            try {
                const response = await window.api.delete(`/educationdepartments/${id}`);
                if (response.success) {
                    alert(response.message);
                    currentEducationDepartmentsPage = 1;
                    await loadEducationDepartments(1);
                } else {
                    alert(response.message || 'Ошибка удаления УО.');
                }
            } catch (error) {
                console.error('Ошибка удаления УО:', error);
                alert('Произошла ошибка при удалении УО.');
            }
        }

        async function loadOrganizationsForSelectedDepartment(page = 1) {
            const educationDepartmentId = document.getElementById('selectedEducationDepartment').value;
            const tableBody = document.getElementById('organizationsTableBody');
            const addOrganizationBtn = document.getElementById('addOrganizationBtn');
            
            tableBody.innerHTML = ''; // Clear previous data

            if (!educationDepartmentId) {
                tableBody.innerHTML = '<tr><td colspan="6" class="text-center">Выберите УО для просмотра организаций.</td></tr>';
                addOrganizationBtn.disabled = true;
                document.getElementById('organizationsPagination').innerHTML = '';
                return;
            }

            // Активируем кнопку добавления организации
            addOrganizationBtn.disabled = false;

            try {
                const response = await window.api.get(`/stores/by-education-department/${educationDepartmentId}`);
                if (response.success && response.data.length > 0) {
                    // Сохраняем все данные для пагинации
                    allOrganizations = response.data;
                    
                    // Вычисляем пагинацию
                    const totalPages = Math.ceil(response.data.length / itemsPerPage);
                    const startIndex = (page - 1) * itemsPerPage;
                    const endIndex = Math.min(startIndex + itemsPerPage, response.data.length);
                    const pageData = response.data.slice(startIndex, endIndex);
                    
                    // Отображаем данные для текущей страницы
                    pageData.forEach(org => {
                        const row = tableBody.insertRow();
                        row.insertCell().textContent = org.name;
                        row.insertCell().textContent = org.city || '';
                        row.insertCell().textContent = org.address || '';
                        row.insertCell().textContent = org.phone || '';
                        row.insertCell().textContent = org.manager || '';
                        
                        const actionsCell = row.insertCell();
                        const editBtn = document.createElement('button');
                        editBtn.className = 'btn btn-sm btn-info me-2';
                        editBtn.textContent = 'Редактировать';
                        editBtn.onclick = () => openOrganizationModal(org);
                        actionsCell.appendChild(editBtn);

                        const deleteBtn = document.createElement('button');
                        deleteBtn.className = 'btn btn-sm btn-danger';
                        deleteBtn.textContent = 'Удалить';
                        deleteBtn.onclick = () => deleteOrganization(org.id);
                        actionsCell.appendChild(deleteBtn);
                    });
                    
                    // Обновляем пагинацию
                    updateOrganizationsPagination(page, totalPages);
                } else {
                    tableBody.innerHTML = '<tr><td colspan="6" class="text-center">Нет организаций, привязанных к этому УО.</td></tr>';
                    document.getElementById('organizationsPagination').innerHTML = '';
                }
            } catch (error) {
                console.error('Ошибка при загрузке организаций для УО:', error);
                tableBody.innerHTML = '<tr><td colspan="6" class="text-center text-danger">Ошибка загрузки организаций.</td></tr>';
            }
        }

        // Функция для обновления пагинации организаций
        function updateOrganizationsPagination(currentPage, totalPages) {
            const pagination = document.getElementById('organizationsPagination');
            pagination.innerHTML = '';

            if (totalPages <= 1) return;

            // Кнопка "Предыдущая"
            const prevLi = document.createElement('li');
            prevLi.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
            const prevLink = document.createElement('a');
            prevLink.className = 'page-link';
            prevLink.href = '#';
            prevLink.textContent = 'Предыдущая';
            prevLink.onclick = (e) => {
                e.preventDefault();
                if (currentPage > 1) {
                    currentOrganizationsPage = currentPage - 1;
                    loadOrganizationsForSelectedDepartment(currentOrganizationsPage);
                }
            };
            prevLi.appendChild(prevLink);
            pagination.appendChild(prevLi);

            // Номера страниц
            const startPage = Math.max(1, currentPage - 2);
            const endPage = Math.min(totalPages, currentPage + 2);

            for (let i = startPage; i <= endPage; i++) {
                const li = document.createElement('li');
                li.className = `page-item ${i === currentPage ? 'active' : ''}`;
                const link = document.createElement('a');
                link.className = 'page-link';
                link.href = '#';
                link.textContent = i;
                link.onclick = (e) => {
                    e.preventDefault();
                    currentOrganizationsPage = i;
                    loadOrganizationsForSelectedDepartment(currentOrganizationsPage);
                };
                li.appendChild(link);
                pagination.appendChild(li);
            }

            // Кнопка "Следующая"
            const nextLi = document.createElement('li');
            nextLi.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
            const nextLink = document.createElement('a');
            nextLink.className = 'page-link';
            nextLink.href = '#';
            nextLink.textContent = 'Следующая';
            nextLink.onclick = (e) => {
                e.preventDefault();
                if (currentPage < totalPages) {
                    currentOrganizationsPage = currentPage + 1;
                    loadOrganizationsForSelectedDepartment(currentOrganizationsPage);
                }
            };
            nextLi.appendChild(nextLink);
            pagination.appendChild(nextLi);
        }

        // Функции для работы с организациями
        function openOrganizationModal(org = null) {
            const educationDepartmentId = document.getElementById('selectedEducationDepartment').value;
            if (!educationDepartmentId) {
                alert('Сначала выберите УО');
                return;
            }

            // Очищаем все возможные backdrop элементы перед открытием
            const existingBackdrops = document.querySelectorAll('.modal-backdrop');
            existingBackdrops.forEach(backdrop => backdrop.remove());
            
            // Восстанавливаем body
            document.body.classList.remove('modal-open');
            document.body.style.overflow = '';
            document.body.style.paddingRight = '';
            
            const modalLabel = document.getElementById('organizationModalLabel');
            const form = document.getElementById('organizationForm');
            form.reset();
            document.getElementById('organizationFormResult').innerHTML = '';

            // Устанавливаем ID выбранного УО
            document.getElementById('organizationEducationDepartmentId').value = educationDepartmentId;

            if (org) {
                modalLabel.textContent = 'Редактировать организацию';
                document.getElementById('organizationId').value = org.id;
                document.getElementById('organizationName').value = org.name;
                document.getElementById('organizationCity').value = org.city || '';
                document.getElementById('organizationAddress').value = org.address || '';
                document.getElementById('organizationPhone').value = org.phone || '';
                document.getElementById('organizationEmail').value = org.manager || '';
            } else {
                modalLabel.textContent = 'Добавить организацию';
                document.getElementById('organizationId').value = '';
            }
            
            const modalElement = document.getElementById('organizationModal');
            
            // Удаляем старые обработчики событий
            modalElement.removeEventListener('hidden.bs.modal', handleOrganizationModalHidden);
            
            // Добавляем обработчик для правильного закрытия модального окна
            modalElement.addEventListener('hidden.bs.modal', handleOrganizationModalHidden);
            
            const modal = new bootstrap.Modal(modalElement);
            modal.show();
        }

        function handleOrganizationModalHidden() {
            // Очищаем форму при закрытии
            const form = document.getElementById('organizationForm');
            form.reset();
            document.getElementById('organizationFormResult').innerHTML = '';
            
            // Принудительно удаляем все backdrop элементы
            const backdrops = document.querySelectorAll('.modal-backdrop');
            backdrops.forEach(backdrop => backdrop.remove());
            
            // Восстанавливаем body
            document.body.classList.remove('modal-open');
            document.body.style.overflow = '';
            document.body.style.paddingRight = '';
            
            // Дополнительная очистка через небольшую задержку
            setTimeout(() => {
                const remainingBackdrops = document.querySelectorAll('.modal-backdrop');
                remainingBackdrops.forEach(backdrop => backdrop.remove());
                
                if (document.body.classList.contains('modal-open')) {
                    document.body.classList.remove('modal-open');
                    document.body.style.overflow = '';
                    document.body.style.paddingRight = '';
                }
            }, 100);
        }

        function handleOrganizationModalClose() {
            const modalElement = document.getElementById('organizationModal');
            
            // Принудительно закрываем модальное окно
            modalElement.classList.remove('show');
            modalElement.style.display = 'none';
            modalElement.setAttribute('aria-hidden', 'true');
            modalElement.removeAttribute('aria-modal');
            
            // Удаляем backdrop и восстанавливаем body
            document.body.classList.remove('modal-open');
            document.body.style.overflow = '';
            document.body.style.paddingRight = '';
            
            // Удаляем все backdrop элементы
            const backdrops = document.querySelectorAll('.modal-backdrop');
            backdrops.forEach(backdrop => backdrop.remove());
            
            // Дополнительная очистка
            setTimeout(() => {
                const remainingBackdrops = document.querySelectorAll('.modal-backdrop');
                remainingBackdrops.forEach(backdrop => backdrop.remove());
                
                if (document.body.classList.contains('modal-open')) {
                    document.body.classList.remove('modal-open');
                    document.body.style.overflow = '';
                    document.body.style.paddingRight = '';
                }
            }, 100);
        }

        async function deleteOrganization(id) {
            if (!confirm('Вы уверены, что хотите удалить эту организацию?')) {
                return;
            }
            try {
                const response = await window.api.delete(`/stores/${id}`);
                if (response.success) {
                    alert(response.message);
                    currentOrganizationsPage = 1;
                    await loadOrganizationsForSelectedDepartment(1);
                } else {
                    alert(response.message || 'Ошибка удаления организации.');
                }
            } catch (error) {
                console.error('Ошибка удаления организации:', error);
                alert('Произошла ошибка при удалении организации.');
            }
        }

        // Добавляем обработчик формы для организаций
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('organizationForm').addEventListener('submit', async function (e) {
                e.preventDefault();
                const id = document.getElementById('organizationId').value;
                const educationDepartmentId = document.getElementById('organizationEducationDepartmentId').value;
                const name = document.getElementById('organizationName').value;
                const city = document.getElementById('organizationCity').value;
                const address = document.getElementById('organizationAddress').value;
                const phone = document.getElementById('organizationPhone').value;
                const email = document.getElementById('organizationEmail').value;
                const resultDiv = document.getElementById('organizationFormResult');

                const payload = { 
                    name, 
                    city, 
                    address, 
                    phone, 
                    manager: email, // Используем поле email как manager
                    educationDepartmentId: parseInt(educationDepartmentId),
                    isActive: true 
                };
                console.log('Отправляем данные организации:', payload);

                try {
                    if (typeof window.api === 'undefined') {
                        console.error('API не определен в обработчике формы организации! Создаем новый экземпляр...');
                        window.api = new ApiClient();
                    }
                    
                    let response;
                    if (id) {
                        console.log('Обновляем организацию с ID:', id);
                        response = await window.api.put(`/stores/${id}`, payload);
                    } else {
                        console.log('Создаем новую организацию');
                        response = await window.api.post('/stores', payload);
                    }
                    console.log('Получен ответ:', response);

                    if (response.success) {
                        resultDiv.innerHTML = `<div class="alert alert-success">${response.message}</div>`;
                        
                        // Закрываем модальное окно правильно
                        const modalElement = document.getElementById('organizationModal');
                        const modal = bootstrap.Modal.getInstance(modalElement);
                        
                        // Принудительно закрываем модальное окно
                        modalElement.classList.remove('show');
                        modalElement.style.display = 'none';
                        modalElement.setAttribute('aria-hidden', 'true');
                        modalElement.removeAttribute('aria-modal');
                        
                        // Удаляем backdrop и восстанавливаем body
                        document.body.classList.remove('modal-open');
                        document.body.style.overflow = '';
                        document.body.style.paddingRight = '';
                        
                        // Удаляем все backdrop элементы
                        const backdrops = document.querySelectorAll('.modal-backdrop');
                        backdrops.forEach(backdrop => backdrop.remove());
                        
                        // Очищаем форму после успешного сохранения
                        setTimeout(() => {
                            document.getElementById('organizationForm').reset();
                            document.getElementById('organizationFormResult').innerHTML = '';
                        }, 500);
                        
                        currentOrganizationsPage = 1;
                    await loadOrganizationsForSelectedDepartment(1);
                    } else {
                        resultDiv.innerHTML = `<div class="alert alert-danger">${response.message || 'Ошибка сохранения организации.'}</div>`;
                    }
                } catch (error) {
                    console.error('Ошибка сохранения организации:', error);
                    resultDiv.innerHTML = `<div class="alert alert-danger">Произошла ошибка: ${error.message || 'Неизвестная ошибка.'}</div>`;
                }
            });
        });
    </script>
}
