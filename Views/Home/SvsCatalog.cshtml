@{
    ViewData["Title"] = "Справочник СВС";
}

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h3 class="card-title mb-0">
                        <i class="fas fa-list me-2"></i>Справочник СВС и история обновлений
                    </h3>
                </div>
                <div class="card-body">
                    <div class="row mb-4">
                        <div class="col-md-4">
                            <div class="card bg-light">
                                <div class="card-body">
                                    <h5 class="card-title">Всего материалов СВС</h5>
                                    <p class="card-text fs-4" id="totalMaterials">0</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card bg-success text-white">
                                <div class="card-body">
                                    <h5 class="card-title">Сопоставлено</h5>
                                    <p class="card-text fs-4" id="mappedMaterials">0</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card bg-warning text-dark">
                                <div class="card-body">
                                    <h5 class="card-title">Не сопоставлено</h5>
                                    <p class="card-text fs-4" id="unmappedMaterials">0</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <h4>Последние обновления справочника</h4>
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>Дата обновления</th>
                                    <th>Источник</th>
                                    <th>УО</th>
                                    <th>Всего</th>
                                    <th>Сопоставлено</th>
                                    <th>Не сопоставлено</th>
                                    <th>Примечания</th>
                                </tr>
                            </thead>
                            <tbody id="svsUpdatesTableBody">
                                <tr><td colspan="7" class="text-center">Загрузка...</td></tr>
                            </tbody>
                        </table>
                    </div>

                    <h4 class="mt-4">Обновить справочник СВС</h4>
                    <form id="svsCatalogUpdateForm">
                        <div class="mb-3">
                            <label for="svsUpdateEducationDepartment" class="form-label">Управление образования (опционально)</label>
                            <select class="form-select" id="svsUpdateEducationDepartment">
                                <option value="">Общий справочник</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="svsJsonData" class="form-label">JSON данные справочника СВС</label>
                            <textarea class="form-control" id="svsJsonData" rows="10" placeholder='{"MatItem":[{"GroupMatId":1492,"MatId":1377,"MeasureId":1,"NameGroupMat":"Банка","NameMat":"Банка пластик","NameMeasure":"шт"}]}' required></textarea>
                            <div class="form-text">Вставьте JSON-структуру справочника материалов СВС.</div>
                        </div>
                        <div class="mb-3">
                            <label for="updateNotes" class="form-label">Примечания к обновлению (опционально)</label>
                            <input type="text" class="form-control" id="updateNotes" maxlength="500">
                        </div>
                        <button type="submit" class="btn btn-primary">Обновить справочник СВС</button>
                    </form>
                    <div id="svsUpdateResult" class="mt-3"></div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', async function () {
            await loadSvsStats();
            await loadSvsUpdates();
            await loadEducationDepartmentsForSvsUpdate();

            document.getElementById('svsCatalogUpdateForm').addEventListener('submit', async function (e) {
                e.preventDefault();
                const jsonData = document.getElementById('svsJsonData').value;
                const educationDepartmentId = document.getElementById('svsUpdateEducationDepartment').value;
                const updateNotes = document.getElementById('updateNotes').value;
                const resultDiv = document.getElementById('svsUpdateResult');
                resultDiv.innerHTML = '<div class="alert alert-info">Отправка данных...</div>';

                try {
                    const url = educationDepartmentId ? `/api/svs/materials?educationDepartmentId=${educationDepartmentId}` : '/api/svs/materials';
                    const payload = {
                        MatItem: JSON.parse(jsonData).MatItem,
                        Notes: updateNotes,
                        UpdateSource: "Manual UI"
                    };
                    const response = await api.post(url, payload);
                    if (response.success) {
                        resultDiv.innerHTML = `<div class="alert alert-success">${response.message}</div>`;
                        await loadSvsStats();
                        await loadSvsUpdates();
                    } else {
                        resultDiv.innerHTML = `<div class="alert alert-danger">${response.message || 'Ошибка при отправке справочника СВС.'}</div>`;
                    }
                } catch (error) {
                    console.error('Ошибка при отправке справочника СВС:', error);
                    resultDiv.innerHTML = `<div class="alert alert-danger">Произошла ошибка: ${error.message || 'Неизвестная ошибка.'}</div>`;
                }
            });
        });

        async function loadSvsStats() {
            try {
                const response = await api.get('/api/svs/svs-stats');
                if (response.success) {
                    document.getElementById('totalMaterials').textContent = response.data.totalMaterials;
                    document.getElementById('mappedMaterials').textContent = response.data.mappedMaterials;
                    document.getElementById('unmappedMaterials').textContent = response.data.unmappedMaterials;
                }
            } catch (error) {
                console.error('Ошибка при загрузке статистики СВС:', error);
            }
        }

        async function loadSvsUpdates() {
            try {
                const response = await api.get('/api/svs/updates');
                const tableBody = document.getElementById('svsUpdatesTableBody');
                tableBody.innerHTML = ''; // Clear previous data

                if (response.success && response.data.length > 0) {
                    response.data.forEach(update => {
                        const row = tableBody.insertRow();
                        row.insertCell().textContent = new Date(update.updateDate).toLocaleString();
                        row.insertCell().textContent = update.updateSource;
                        row.insertCell().textContent = update.educationDepartmentName || 'Общий';
                        row.insertCell().textContent = update.totalMaterials;
                        row.insertCell().textContent = update.mappedMaterials;
                        row.insertCell().textContent = update.unmappedMaterials;
                        row.insertCell().textContent = update.notes || '';
                    });
                } else {
                    tableBody.innerHTML = '<tr><td colspan="7" class="text-center">Нет данных об обновлениях.</td></tr>';
                }
            } catch (error) {
                console.error('Ошибка при загрузке истории обновлений СВС:', error);
                const tableBody = document.getElementById('svsUpdatesTableBody');
                tableBody.innerHTML = '<tr><td colspan="7" class="text-center text-danger">Ошибка загрузки истории обновлений.</td></tr>';
            }
        }

        async function loadEducationDepartmentsForSvsUpdate() {
            try {
                const result = await api.get('/api/educationdepartments');
                if (result && result.success) {
                    const departments = result.data;
                    const selectElement = document.getElementById('svsUpdateEducationDepartment');
                    selectElement.innerHTML = '<option value="">Общий справочник</option>'; // Default option

                    departments.forEach(dep => {
                        const option = document.createElement('option');
                        option.value = dep.id;
                        option.textContent = `${dep.name} (${dep.city})`;
                        selectElement.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Ошибка при загрузке УО:', error);
            }
        }
    </script>
}