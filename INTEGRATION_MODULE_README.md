# Интеграционный модуль (ИМ) для обмена данными между СВС и ПО по учёту питания

## Описание

Интеграционный модуль предназначен для обеспечения обмена данными между системой бухгалтерского учёта СВС (КЗ «Бухгалтерский учёт. Учёт валютных операций. Складской учёт») и программным обеспечением по учёту питания через универсальную структуру данных.

## Основные возможности

### 1. Импорт данных
- **Импорт данных потребления** - загрузка CSV файлов с данными о расходе продуктов по категориям питающихся
- **Импорт справочника продуктов** - загрузка справочников продуктов питания
- **Импорт данных прихода** - загрузка накладных по приходу продуктов

### 2. Сопоставление продуктов
- **Автоматическое сопоставление** - система автоматически сопоставляет продукты по коду и названию
- **Ручное сопоставление** - возможность ручного сопоставления через удобный интерфейс
- **Утверждение сопоставлений** - система позволяет утверждать сопоставления для использования

### 3. API для обмена данными
- **Получение данных потребления** - API для получения данных по расходу продуктов
- **Получение данных прихода** - API для получения накладных
- **Получение справочников** - API для получения справочников продуктов
- **Проверка доступности данных** - API для проверки наличия данных на дату

## Структура данных

### Формат CSV файла для импорта данных потребления

Файл должен содержать следующие колонки:
- `id продукта` - идентификатор продукта
- `Шифр продукта` - код продукта
- `Название продукта` - наименование продукта
- `ед.изм.` - единица измерения
- `Дата расхода` - дата расхода в формате YYYY-MM-DD
- `Ясли 10,5 к-во` - количество для ясельной группы
- `Ясли 10,5 стоимость` - стоимость для ясельной группы
- `САД 10,5 к-во` - количество для дошкольной группы
- `САД 10,5 стоимость` - стоимость для дошкольной группы
- `Сотрудники к-во` - количество для сотрудников
- `Сотрудники стоимость` - стоимость для сотрудников
- `Всего к-во` - общее количество
- `Всего стоимость` - общая стоимость

## Установка и запуск

### Требования
- .NET 8.0 SDK
- PostgreSQL 12+
- Visual Studio 2022 или VS Code

### Установка зависимостей
```bash
dotnet restore
```

### Настройка базы данных
1. Создайте базу данных PostgreSQL
2. Обновите строку подключения в `appsettings.json`:
```json
{
  "ConnectionStrings": {
    "DefaultConnection": "Host=localhost;Database=ExchangeSystem;Username=your_username;Password=your_password"
  }
}
```

### Применение миграций
```bash
dotnet ef database update
```

### Запуск приложения
```bash
dotnet run
```

Приложение будет доступно по адресу: `https://localhost:5001`

## Использование

### 1. Авторизация
- Логин: `admin`
- Пароль: `admin123`

### 2. Импорт данных
1. Перейдите в раздел "Импорт данных"
2. Выберите тип импорта (потребление, продукты, приход)
3. Загрузите CSV файл
4. Просмотрите результаты импорта

### 3. Сопоставление продуктов
1. Перейдите в раздел "Сопоставление продуктов"
2. Используйте автоматическое сопоставление для быстрого сопоставления
3. Ручное сопоставление для точной настройки
4. Утвердите сопоставления

### 4. API для СВС

#### Получение данных потребления
```http
GET /api/svs/consumption?organizationId=123&date=2020-05-06
```

#### Получение данных прихода
```http
GET /api/svs/receipts?organizationId=123&date=2020-05-06
```

#### Получение справочника продуктов
```http
GET /api/svs/products
```

#### Проверка доступности данных
```http
GET /api/svs/check-data-availability?date=2020-05-06
```

## API Endpoints

### Импорт данных
- `POST /api/DataImport/consumption` - импорт данных потребления
- `POST /api/DataImport/products` - импорт справочника продуктов
- `POST /api/DataImport/receipts` - импорт данных прихода
- `GET /api/DataImport/history` - история импорта
- `GET /api/DataImport/errors/{importLogId}` - ошибки импорта

### Сопоставление продуктов
- `GET /api/ProductMapping` - получение всех сопоставлений
- `POST /api/ProductMapping` - создание сопоставления
- `PUT /api/ProductMapping/{id}` - обновление сопоставления
- `DELETE /api/ProductMapping/{id}` - удаление сопоставления
- `POST /api/ProductMapping/auto-map` - автоматическое сопоставление
- `GET /api/ProductMapping/search-svs-products` - поиск продуктов СВС

### API для СВС
- `GET /api/svs/consumption` - данные потребления
- `GET /api/svs/receipts` - данные прихода
- `GET /api/svs/products` - справочник продуктов
- `GET /api/svs/product-mappings` - сопоставления продуктов
- `GET /api/svs/organizations-data` - данные по всем организациям
- `GET /api/svs/check-data-availability` - проверка доступности данных

## Архитектура

### Модели данных
- `Product` - продукты
- `ProductMapping` - сопоставления продуктов
- `ProductConsumption` - расход продуктов
- `ProductReceipt` - приход продуктов
- `ConsumptionCategory` - категории питающихся
- `DataImportLog` - логи импорта
- `DataImportError` - ошибки импорта

### Сервисы
- `CsvParserService` - парсинг CSV файлов
- `DataImportService` - импорт данных
- `ProductMappingService` - управление сопоставлениями

### Контроллеры
- `DataImportController` - API для импорта
- `ProductMappingController` - API для сопоставлений
- `SvsApiController` - API для СВС
- `HomeController` - веб-интерфейс

## Безопасность

- Аутентификация через cookies
- Авторизация по ролям
- Валидация входных данных
- Логирование всех операций

## Мониторинг

- Логи импорта данных
- Отслеживание ошибок
- Статистика обработки
- История операций

## Поддержка

Для получения поддержки обращайтесь к администратору системы.

## Лицензия

Внутреннее использование в рамках проекта ИВЦ МФ.

