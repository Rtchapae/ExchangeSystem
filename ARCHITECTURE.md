# Архитектура интеграционного модуля

## Общая схема системы

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   ПО по учёту   │    │  Интеграционный │    │      СВС        │
│    питания      │    │     модуль      │    │                 │
│                 │    │                 │    │                 │
│  ┌───────────┐  │    │  ┌───────────┐  │    │  ┌───────────┐  │
│  │ CSV файлы │  │───▶│  │   ИМ      │  │◀───│  │   API     │  │
│  │           │  │    │  │           │  │    │  │ запросы  │  │
│  └───────────┘  │    │  └───────────┘  │    │  └───────────┘  │
│                 │    │                 │    │                 │
│  ┌───────────┐  │    │  ┌───────────┐  │    │  ┌───────────┐  │
│  │ JSON API  │  │◀───│  │   API     │  │───▶│  │  Данные   │  │
│  │           │  │    │  │  ответы   │  │    │  │           │  │
│  └───────────┘  │    │  └───────────┘  │    │  └───────────┘  │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

## Компоненты системы

### 1. Веб-интерфейс
```
┌─────────────────────────────────────────────────────────────┐
│                    Веб-интерфейс                            │
├─────────────────────────────────────────────────────────────┤
│  • Импорт данных (CSV файлы)                               │
│  • Сопоставление продуктов                                 │
│  • Просмотр истории импорта                                │
│  • Управление сопоставлениями                              │
│  • Мониторинг системы                                      │
└─────────────────────────────────────────────────────────────┘
```

### 2. API слой
```
┌─────────────────────────────────────────────────────────────┐
│                      API контроллеры                        │
├─────────────────────────────────────────────────────────────┤
│  • DataImportController - импорт данных                    │
│  • ProductMappingController - сопоставления               │
│  • SvsApiController - API для СВС                         │
│  • AuthController - аутентификация                        │
└─────────────────────────────────────────────────────────────┘
```

### 3. Бизнес-логика
```
┌─────────────────────────────────────────────────────────────┐
│                    Сервисы                                 │
├─────────────────────────────────────────────────────────────┤
│  • CsvParserService - парсинг CSV                          │
│  • DataImportService - импорт данных                       │
│  • ProductMappingService - сопоставления                  │
│  • AuthService - аутентификация                           │
└─────────────────────────────────────────────────────────────┘
```

### 4. Слой данных
```
┌─────────────────────────────────────────────────────────────┐
│                    Модели данных                            │
├─────────────────────────────────────────────────────────────┤
│  • Product - продукты                                      │
│  • ProductMapping - сопоставления                          │
│  • ProductConsumption - расход продуктов                   │
│  • ProductReceipt - приход продуктов                       │
│  • ConsumptionCategory - категории питающихся             │
│  • DataImportLog - логи импорта                            │
│  • DataImportError - ошибки импорта                       │
└─────────────────────────────────────────────────────────────┘
```

## Поток данных

### 1. Импорт данных
```
CSV файл → CsvParserService → DataImportService → База данных
                ↓
         Валидация данных
                ↓
         Обработка ошибок
                ↓
         Логирование
```

### 2. Сопоставление продуктов
```
Внешние продукты → ProductMappingService → Сопоставления
                        ↓
                Автоматическое сопоставление
                        ↓
                Ручное сопоставление
                        ↓
                Утверждение
```

### 3. Обмен с СВС
```
СВС → API запрос → SvsApiController → База данных
                        ↓
                Фильтрация данных
                        ↓
                Форматирование JSON
                        ↓
                Ответ СВС
```

## Технологический стек

### Backend
- **.NET 8.0** - основная платформа
- **ASP.NET Core** - веб-фреймворк
- **Entity Framework Core** - ORM
- **PostgreSQL** - база данных
- **CsvHelper** - парсинг CSV
- **BCrypt** - хеширование паролей

### Frontend
- **Bootstrap 5** - UI фреймворк
- **jQuery** - JavaScript библиотека
- **Font Awesome** - иконки
- **Razor Pages** - серверный рендеринг

### Инфраструктура
- **Docker** - контейнеризация (опционально)
- **Nginx** - веб-сервер (опционально)
- **SSL/TLS** - шифрование
- **CORS** - межсайтовые запросы

## Безопасность

### Аутентификация
```
Пользователь → Логин/Пароль → BCrypt → Сессия
```

### Авторизация
```
Запрос → Проверка сессии → Проверка роли → Доступ
```

### Валидация данных
```
Входные данные → Валидация → Санитизация → Обработка
```

## Масштабируемость

### Горизонтальное масштабирование
- Множественные экземпляры приложения
- Балансировщик нагрузки
- Общая база данных

### Вертикальное масштабирование
- Увеличение ресурсов сервера
- Оптимизация запросов к БД
- Кэширование данных

## Мониторинг

### Логирование
- Логи импорта данных
- Ошибки обработки
- API запросы
- Производительность

### Метрики
- Количество импортов
- Успешность операций
- Время обработки
- Использование ресурсов

## Развертывание

### Разработка
```bash
dotnet run
```

### Продакшн
```bash
dotnet publish -c Release
# Развертывание на сервере
```

### Docker
```dockerfile
FROM mcr.microsoft.com/dotnet/aspnet:8.0
COPY . /app
WORKDIR /app
EXPOSE 80
ENTRYPOINT ["dotnet", "ExchangeSystem.dll"]
```

## Интеграция с внешними системами

### ПО по учёту питания
- Загрузка CSV файлов
- API для получения данных
- Синхронизация справочников

### СВС
- API для получения данных
- Форматирование данных
- Обработка ошибок

## Будущие улучшения

### Планируемые функции
- Машинное обучение для сопоставления
- Автоматическая синхронизация
- Расширенная аналитика
- Мобильное приложение

### Технические улучшения
- Микросервисная архитектура
- Event-driven архитектура
- Кэширование Redis
- Message Queue

